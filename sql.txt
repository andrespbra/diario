
-- SCRIPT DE SEGURANÇA REFINADA - DIÁRIO DE BORDO
-- Implementa restrição: Analista vê apenas o seu / Admin vê tudo

-- 1. Limpeza de políticas anteriores
DO $$ 
DECLARE 
    pol record;
BEGIN
    FOR pol IN (SELECT policyname, tablename FROM pg_policies WHERE schemaname = 'public') LOOP
        EXECUTE format('DROP POLICY IF EXISTS %I ON %I', pol.policyname, pol.tablename);
    END LOOP;
END $$;

-- 2. Garantir permissões básicas de RLS
ALTER TABLE public.user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.tickets ENABLE ROW LEVEL SECURITY;

-- 3. Políticas para USER_PROFILES
-- Usuário vê o próprio perfil OU Admin vê todos (usando metadados do JWT para evitar recursão)
CREATE POLICY "profiles_select_policy" ON public.user_profiles 
FOR SELECT TO authenticated 
USING (
  auth.uid() = id OR 
  (auth.jwt() -> 'user_metadata' ->> 'nivel') = 'Admin'
);

-- 4. Políticas para TICKETS
-- SELECT: Analista vê apenas os seus (user_id = auth.uid()) OR Admin vê todos
CREATE POLICY "tickets_select_policy" ON public.tickets 
FOR SELECT TO authenticated 
USING (
  auth.uid() = user_id OR 
  (auth.jwt() -> 'user_metadata' ->> 'nivel') = 'Admin'
);

-- INSERT: Qualquer usuário autenticado pode inserir
CREATE POLICY "tickets_insert_policy" ON public.tickets 
FOR INSERT TO authenticated 
WITH CHECK (true);

-- UPDATE: Usuário altera o seu próprio OU Admin altera qualquer um
CREATE POLICY "tickets_update_policy" ON public.tickets 
FOR UPDATE TO authenticated 
USING (
  auth.uid() = user_id OR 
  (auth.jwt() -> 'user_metadata' ->> 'nivel') = 'Admin'
);

-- DELETE: Apenas Admins podem deletar registros para auditoria (opcional, mude conforme necessidade)
CREATE POLICY "tickets_delete_policy" ON public.tickets 
FOR DELETE TO authenticated 
USING (
  (auth.jwt() -> 'user_metadata' ->> 'nivel') = 'Admin'
);

-- 5. Permissões de Tabela
GRANT ALL ON ALL TABLES IN SCHEMA public TO authenticated;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO authenticated;
